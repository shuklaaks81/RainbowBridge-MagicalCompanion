<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ child.name }}'s Magical Companion - Rainbow Bridge ✨🌈</title>
    <style>
        /* Sensory-friendly design with rainbow theme */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 20%, #fecfef 40%, #a8edea 60%, #fed6e3 80%, #d299c2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #4a90e2;
            font-size: 2rem;
        }

        .back-btn {
            background: #50c878;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .back-btn:hover {
            background: #45b069;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .main-panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-header {
            background: #4a90e2;
            color: white;
            padding: 20px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .panel-content {
            padding: 20px;
        }

        .chat-container {
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            max-width: 80%;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .message.user {
            background: #4a90e2;
            color: white;
            margin-left: auto;
            flex-direction: row-reverse;
            text-align: right;
        }

        .message.ai {
            background: #50c878;
            color: white;
        }

        .message-profile {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message-profile img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-sender {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 4px;
            opacity: 0.9;
        }

        .message.user .message-sender {
            text-align: right;
        }

        .visual-cues {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .visual-cue {
            background: white;
            color: #4a90e2;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            border: 2px solid #4a90e2;
        }

        .chat-input-area {
            padding: 20px;
            background: white;
            border-top: 2px solid #e9ecef;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .chat-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .send-btn {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .send-btn:hover {
            background: #357abd;
        }

        .visual-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .visual-card {
            background: #f8f9fa;
            border: 3px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .visual-card:hover {
            border-color: #4a90e2;
            background: #e3f2fd;
            transform: translateY(-2px);
        }

        .visual-card.selected {
            border-color: #50c878;
            background: #e8f5e8;
        }

        .visual-card .icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .visual-card .label {
            font-size: 0.9rem;
            font-weight: bold;
            color: #333;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .card-header {
            background: #50c878;
            color: white;
            padding: 15px 20px;
            font-weight: bold;
        }

        .card-content {
            padding: 20px;
        }

        .routine-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #4a90e2;
            transition: all 0.3s ease;
        }

        .routine-item:hover {
            background: #e3f2fd;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .routine-item h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .routine-item p {
            color: #666;
            font-size: 0.9rem;
            margin: 5px 0;
        }

        .routine-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .routine-actions .btn {
            font-size: 0.8rem;
            padding: 8px 12px;
        }

        .routine-progress {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
        }

        .routine-progress .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .routine-progress .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a90e2, #50c878);
            transition: width 0.3s ease;
        }

        .routine-progress .progress-text {
            font-size: 0.8rem;
            color: #666;
            text-align: center;
            margin: 0;
        }

        .no-routines {
            text-align: center;
            padding: 30px 20px;
            color: #666;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #ddd;
        }

        .no-routines p {
            margin: 5px 0;
        }

        .progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .progress-item:last-child {
            border-bottom: none;
        }

        .progress-bar {
            width: 100px;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #50c878;
            transition: width 0.3s ease;
        }

        .btn {
            display: inline-block;
            padding: 12px 20px;
            background: #4a90e2;
            color: white;
            text-decoration: none;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background: #357abd;
        }

        .btn-success {
            background: #50c878;
        }

        .btn-success:hover {
            background: #45b069;
        }

        .communication-mode {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-btn {
            padding: 8px 15px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            border-color: #4a90e2;
            background: #4a90e2;
            color: white;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .visual-cards-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>� {{ child.name }}'s Rainbow Bridge</h1>
            <a href="/" class="back-btn">← Back to Home</a>
        </div>

        <div class="dashboard-grid">
            <div class="main-panel">
                <div class="panel-header">
                    🌈 Chat with Rainbow Bridge
                </div>
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai">
                            <div class="message-profile">
                                <img src="/static/images/profiles/rainbow-bridge.svg" alt="🌈 Rainbow Bridge">
                            </div>
                            <div class="message-content">
                                <div class="message-sender">🌈 Rainbow Bridge</div>
                                <div>Hi {{ child.name }}! 🌈 I'm Rainbow Bridge, your colorful companion! How are you feeling today?</div>
                                <div class="visual-cues">
                                    <span class="visual-cue">😊</span>
                                    <span class="visual-cue">🌈</span>
                                    <span class="visual-cue">❤️</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <div class="communication-mode">
                            <button class="mode-btn active" onclick="setCommunicationMode('text')">Text</button>
                            <button class="mode-btn" onclick="setCommunicationMode('visual')">Visual</button>
                            <button class="mode-btn" onclick="setCommunicationMode('audio')">Audio</button>
                        </div>
                        <div class="input-group">
                            <input type="text" class="chat-input" id="messageInput" placeholder="Type your message here...">
                            <button class="send-btn" onclick="sendMessage()">Send</button>
                        </div>
                        <div id="visualCardsContainer" class="visual-cards-container" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <div class="side-panel">
                <div class="card">
                    <div class="card-header">
                        📅 Today's Routines
                    </div>
                    <div class="card-content">
                        <div id="routinesList">
                            {% for routine in routines %}
                            <div class="routine-item" id="routine-{{ routine.id }}">
                                <h4>{{ routine.name }}</h4>
                                <p>⏰ {{ routine.schedule_time }}</p>
                                <p>📝 {{ routine.total_activities or routine.activities|length }} activities</p>
                                <div class="routine-actions">
                                    <button class="btn btn-success" onclick="startRoutineWithMCP({{ routine.id }}, '{{ routine.name }}')">▶️ Start</button>
                                    <button class="btn btn-info" onclick="showRoutineDetails({{ routine.id }})">👁️ View</button>
                                </div>
                                <div class="routine-progress" id="progress-{{ routine.id }}" style="display: none;">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: 0%"></div>
                                    </div>
                                    <p class="progress-text">Ready to start!</p>
                                </div>
                            </div>
                            {% endfor %}
                            {% if not routines %}
                            <div class="no-routines">
                                <p>No routines yet! 🌈</p>
                                <p>Try saying: "I want to create a morning routine"</p>
                            </div>
                            {% endif %}
                        </div>
                        <button class="btn" onclick="createRoutineWithMCP()">✨ Create New Routine</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        📊 Progress Overview
                    </div>
                    <div class="card-content">
                        <div class="progress-item">
                            <span>Communication</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{ progress.communication_score }}%"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <span>Routine Adherence</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{ progress.routine_adherence }}%"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <span>Learning Engagement</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{ progress.learning_engagement }}%"></div>
                            </div>
                        </div>
                        <button class="btn" onclick="viewDetailedProgress()">View Detailed Report</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentCommunicationMode = 'text';
        let selectedVisualCards = [];
        let activeRoutineSessions = {}; // Track active routine sessions
        const childId = {{ child.id }};
        const childName = "{{ child.name }}";
        const childProfilePicture = "{{ child.profile_picture or 'default.svg' }}";

        // Load visual cards when page loads
        window.addEventListener('load', async function() {
            await loadVisualCards();
            await loadActiveRoutineSessions();
        });

        async function loadActiveRoutineSessions() {
            try {
                const response = await fetch(`/api/child/${childId}/active-sessions`);
                if (response.ok) {
                    const sessions = await response.json();
                    sessions.forEach(session => {
                        activeRoutineSessions[session.routine_id] = {
                            routineId: session.routine_id,
                            routineName: session.routine_name,
                            startedAt: new Date(session.started_at),
                            progress: session.progress || 0,
                            currentActivity: session.current_activity || 0
                        };
                        
                        // Update UI to show progress
                        updateRoutineProgress(session.routine_id, session.progress || 0, 'In Progress... 🌟');
                    });
                    
                    if (sessions.length > 0) {
                        addMessageToChat(`Welcome back! You have ${sessions.length} routine(s) in progress. You can continue where you left off! 🌈`, 'ai');
                    }
                }
            } catch (error) {
                console.error('Error loading active sessions:', error);
            }
        }

        function setCommunicationMode(mode) {
            currentCommunicationMode = mode;
            
            // Update button states
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide visual cards
            const visualContainer = document.getElementById('visualCardsContainer');
            const messageInput = document.getElementById('messageInput');
            
            if (mode === 'visual') {
                visualContainer.style.display = 'grid';
                messageInput.placeholder = 'Select visual cards or type a message...';
            } else {
                visualContainer.style.display = 'none';
                messageInput.placeholder = mode === 'audio' ? 'Click to record audio or type...' : 'Type your message here...';
            }
        }

        async function loadVisualCards() {
            try {
                const response = await fetch('/api/visual-cards');
                const cards = await response.json();
                
                const container = document.getElementById('visualCardsContainer');
                container.innerHTML = cards.map(card => `
                    <div class="visual-card" onclick="toggleVisualCard('${card.id}', this)">
                        <div class="icon">${getCardIcon(card.category, card.name)}</div>
                        <div class="label">${card.name}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading visual cards:', error);
            }
        }

        function getCardIcon(category, name) {
            const icons = {
                'emotions': {
                    'Happy': '😊', 'Sad': '😢', 'Angry': '😠', 'Calm': '😌', 'Excited': '🤩', 'Tired': '😴'
                },
                'needs': {
                    'Eat': '🍽️', 'Drink': '🥤', 'Bathroom': '🚻', 'Sleep': '🛏️', 'Help': '🆘', 'Break': '⏸️'
                },
                'activities': {
                    'Play': '🎮', 'Read': '📚', 'Music': '🎵', 'Draw': '🎨', 'Outside': '🌳', 'Quiet Time': '🤫'
                },
                'social': {
                    'Yes': '✅', 'No': '❌', 'Please': '🙏', 'Thank You': '🙏', 'Hello': '👋', 'Goodbye': '👋'
                }
            };
            
            return icons[category]?.[name] || '⭐';
        }

        function toggleVisualCard(cardId, element) {
            const index = selectedVisualCards.indexOf(cardId);
            
            if (index > -1) {
                selectedVisualCards.splice(index, 1);
                element.classList.remove('selected');
            } else {
                selectedVisualCards.push(cardId);
                element.classList.add('selected');
            }
            
            updateMessageInput();
        }

        function updateMessageInput() {
            if (selectedVisualCards.length > 0) {
                const cardNames = selectedVisualCards.map(id => {
                    const element = document.querySelector(`[onclick*="${id}"]`);
                    return element ? element.querySelector('.label').textContent : id;
                });
                document.getElementById('messageInput').value = cardNames.join(' + ');
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message && selectedVisualCards.length === 0) return;
            
            const finalMessage = message || selectedVisualCards.join(' + ');
            
            // Check if this might be an activity completion for active sessions
            const hasActiveSessions = Object.keys(activeRoutineSessions).length > 0;
            const isCompletionMessage = /\b(done|finished|completed|complete|did it|finished with)\b/i.test(finalMessage);
            
            if (hasActiveSessions && isCompletionMessage) {
                // Try to extract activity name and complete it
                const sessionIds = Object.keys(activeRoutineSessions);
                if (sessionIds.length === 1) {
                    // Only one active session, assume they're completing an activity for it
                    const routineId = sessionIds[0];
                    const session = activeRoutineSessions[routineId];
                    
                    // Extract potential activity name from message
                    const activityMatch = finalMessage.match(/(?:done with|finished|completed|did)\s+(.+?)(?:\.|$)/i);
                    const activityName = activityMatch ? activityMatch[1].trim() : "current activity";
                    
                    addMessageToChat(finalMessage, 'user');
                    input.value = '';
                    selectedVisualCards = [];
                    document.querySelectorAll('.visual-card.selected').forEach(card => {
                        card.classList.remove('selected');
                    });
                    
                    // Complete the activity directly
                    await completeActivity(routineId, activityName);
                    return;
                }
            }
            
            // Add user message to chat
            addMessageToChat(finalMessage, 'user');
            
            // Clear input and selected cards
            input.value = '';
            selectedVisualCards = [];
            document.querySelectorAll('.visual-card.selected').forEach(card => {
                card.classList.remove('selected');
            });
            
            try {
                const formData = new FormData();
                formData.append('child_id', childId);
                formData.append('message', finalMessage);
                formData.append('communication_type', currentCommunicationMode);
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.text) {
                    addMessageToChat(result.text, 'ai', result.visual_cues);
                } else {
                    addMessageToChat('Sorry, I couldn\'t understand that. Can you try again?', 'ai');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                addMessageToChat('Sorry, there was an error. Please try again.', 'ai');
            }
        }

        function addMessageToChat(message, sender, visualCues = []) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            // Determine profile info
            let profileImage, senderName;
            if (sender === 'user') {
                profileImage = `/static/images/profiles/${childProfilePicture}`;
                senderName = childName;
            } else {
                // AI/Rainbow Bridge
                profileImage = '/static/images/profiles/rainbow-bridge.svg';
                senderName = '🌈 Rainbow Bridge';
            }
            
            let html = `
                <div class="message-profile">
                    <img src="${profileImage}" alt="${senderName}" onerror="this.src='/static/images/profiles/default.svg'">
                </div>
                <div class="message-content">
                    <div class="message-sender">${senderName}</div>
                    <div>${message}</div>`;
            
            if (visualCues && visualCues.length > 0) {
                html += '<div class="visual-cues">';
                visualCues.forEach(cue => {
                    html += `<span class="visual-cue">${getVisualCueIcon(cue)}</span>`;
                });
                html += '</div>';
            }
            
            html += '</div>';
            
            messageDiv.innerHTML = html;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function getVisualCueIcon(cue) {
            const icons = {
                'happy_face': '😊',
                'thumbs_up': '👍',
                'star': '⭐',
                'heart': '❤️',
                'friendly_robot': '🤖',
                'comfort_hug': '🤗',
                'practice_icon': '💪',
                'listening': '👂',
                'musical_note': '🎵'
            };
            return icons[cue] || cue;
        }

        // Allow Enter key to send message
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function startRoutineWithMCP(routineId, routineName) {
            try {
                // Check if there's already an active session for this routine
                if (activeRoutineSessions[routineId]) {
                    addMessageToChat(`You're already working on your ${routineName}! Keep going! 💪`, 'ai');
                    return;
                }
                
                // Directly call the API endpoint without going through chat
                const formData = new FormData();
                formData.append('routine_id', routineId);
                formData.append('child_id', childId);
                
                const response = await fetch('/api/routine/start', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Track this active session
                    activeRoutineSessions[routineId] = {
                        routineId: routineId,
                        routineName: routineName,
                        startedAt: new Date(),
                        progress: 0,
                        currentActivity: 0
                    };
                    
                    // Update the routine UI to show progress
                    updateRoutineProgress(routineId, 0, 'Started! Let\'s begin! 🌟');
                    
                    // Add a success message to chat
                    addMessageToChat(`Great! I've started your ${routineName}. Let's do this together! 💪`, 'ai');
                } else {
                    addMessageToChat(`I had trouble starting your routine. Let's try again! 🤗`, 'ai');
                }
            } catch (error) {
                console.error('Error starting routine:', error);
                addMessageToChat('Oops! Something went wrong. Can you try asking me to start your routine? 😊', 'ai');
            }
        }

        async function createRoutineWithMCP() {
            // Guide the user to create a routine using natural language
            const suggestions = [
                "I want to create a morning routine",
                "Can you help me make a bedtime routine?",
                "I need a routine for my homework time",
                "Create a calm-down routine for me"
            ];
            
            const randomSuggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
            
            // Add a helpful message to the chat
            addMessageToChat(
                `I'd love to help you create a new routine! 🎨✨\n\n` +
                `Just tell me what kind of routine you want. For example, you could say:\n` +
                `"${randomSuggestion}"\n\n` +
                `Type your message below and I'll help you create it step by step! 🌟`,
                'ai'
            );
            
            // Focus on the chat input
            document.getElementById('messageInput').focus();
            document.getElementById('messageInput').placeholder = 'Tell me what routine you want to create...';
        }

        function showRoutineDetails(routineId) {
            // Send a message to get routine details through MCP
            sendMessageToChat(`Tell me about routine ${routineId}`);
        }

        async function completeActivity(routineId, activityName) {
            try {
                if (!activeRoutineSessions[routineId]) {
                    addMessageToChat('Please start your routine first! 😊', 'ai');
                    return;
                }
                
                const formData = new FormData();
                formData.append('routine_id', routineId);
                formData.append('activity_name', activityName);
                formData.append('child_id', childId);
                
                const response = await fetch(`/api/routine/${routineId}/complete-activity`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update session progress
                    const session = activeRoutineSessions[routineId];
                    session.currentActivity++;
                    session.progress = (session.currentActivity / result.totalActivities) * 100;
                    
                    // Update UI
                    updateRoutineProgress(routineId, session.progress, `Great job on ${activityName}! 🌟`);
                    
                    // Add celebration message
                    addMessageToChat(`Wonderful! You completed "${activityName}"! 🎉`, 'ai');
                    
                    // Check if routine is complete
                    if (session.progress >= 100) {
                        delete activeRoutineSessions[routineId];
                        addMessageToChat(`Amazing! You completed your entire ${session.routineName} routine! 🌈✨`, 'ai');
                    }
                } else {
                    addMessageToChat(`I couldn't mark that activity as complete. Let's try again! 😊`, 'ai');
                }
            } catch (error) {
                console.error('Error completing activity:', error);
                addMessageToChat('Oops! Something went wrong. Keep going, you\'re doing great! 💪', 'ai');
            }
        }

        function updateRoutineProgress(routineId, progressPercent, statusText) {
            const progressElement = document.getElementById(`progress-${routineId}`);
            if (progressElement) {
                progressElement.style.display = 'block';
                const progressBar = progressElement.querySelector('.progress-fill');
                const progressText = progressElement.querySelector('.progress-text');
                
                if (progressBar) progressBar.style.width = `${progressPercent}%`;
                if (progressText) progressText.textContent = statusText;
            }
        }

        async function sendMessageToChat(message) {
            // Add the message to chat input and send it
            const messageInput = document.getElementById('messageInput');
            messageInput.value = message;
            await sendMessage();
        }

        // Legacy function for backward compatibility
        async function startRoutine(routineId) {
            const routine = document.querySelector(`#routine-${routineId} h4`);
            const routineName = routine ? routine.textContent : 'routine';
            await startRoutineWithMCP(routineId, routineName);
        }

        function openCreateRoutineModal() {
            // Redirect to new MCP-powered creation
            createRoutineWithMCP();
        }

        function viewDetailedProgress() {
            // This would open a detailed progress view
            window.open(`/api/progress/${childId}`, '_blank');
        }
    </script>
</body>
</html>
